<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="author"
	content="Mark Otto, Jacob Thornton, and Bootstrap contributors">
<meta name="generator" content="Hugo 0.88.1">
<title>Photos</title>

<link rel="canonical"
	href="https://getbootstrap.com/docs/5.1/examples/navbar-fixed/">
<!-- Bootstrap core CSS -->
<link th:href="@{/css/bootstrap.min.css}" rel="stylesheet"
	integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
	crossorigin="anonymous">
<!-- Custom styles for this template -->
<link th:href="@{/css/navbar-top-fixed.css}" rel="stylesheet">

</head>
<body>
	<div th:replace="~{block/header::header}"></div>

	<h1>Album Photos</h1>
	<section>
		<button id="login" onclick="login()" style="display: none;">ログイン</button>
		<button id="logout" onclick="logout()" style="display: none;">ログアウト</button>
		<button id="getAlbums" onclick="getAlbums()" style="display: none;">アルバムリストを取得する</button>
		<button id="getPhotos" onclick="showPhotos()" style="display: none;">アルバムの写真を取得する</button>
	</section>

    <div id="albums">
        <select id="selectAlbum" name="selectAlbum">
        </select>
    </div>
    
    <img id="photo">

    <script defer src="https://apis.google.com/js/api.js"
        onload="this.onload=function(){};handleClientLoad()"
        onreadystatechange="if (this.readyState === 'complete') this.onload()">
    </script>
    
    <script defer type="text/javascript">
      
    const apiKey = 'AIzaSyAQAfHFDGo__LezKIS1mPDS5rz0-HSt2q0';
    const clientId = '808458942654-1s8ba33h9ik6j931eud5pdielct652fv.apps.googleusercontent.com';
    const discoveryDocs = [];
    const scopes = 'https://www.googleapis.com/auth/photoslibrary';

    // Google API Client Library for JavaScript ロード時のイベント
    function handleClientLoad() {
      gapi.load('client:auth2', () => {
        gapi.client.init({
          apiKey: apiKey,
          discoveryDocs: discoveryDocs,
          clientId: clientId,
          scope: scopes
        }).then(function () {
          // サインイン状態を監視し、状態に変化があったときに「updateSigninStatus」を呼ぶ
          gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
          // 初期起動時のサインイン状態で画面制御
          updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
        });
      });
    }

    // ログイン
    function login() {
      gapi.auth2.getAuthInstance().signIn();
    }

    // ログアウト
    function logout() {
      gapi.auth2.getAuthInstance().signOut();
      gapi.auth2.getAuthInstance().disconnect();
    }

    // ログイン・ログアウト状態に変更が発生した時に呼ばれる関数
    function updateSigninStatus(isSignedIn) {
      if (isSignedIn) {
        //ログイン状態
        document.getElementById("login").style.display = 'none';
        document.getElementById("logout").style.display = 'block';
        document.getElementById("getAlbums").style.display = 'block';
        document.getElementById("getPhotos").style.display = 'block';
        document.getElementById("selectAlbum").style.display = 'block';
      } else {
        //ログアウト
        document.getElementById("login").style.display = 'block';
        document.getElementById("logout").style.display = 'none';
        document.getElementById("getAlbums").style.display = 'none';
        document.getElementById("getPhotos").style.display = 'none';
        document.getElementById("selectAlbum").style.display = 'none';
      }
    }
    
    // 取得したアルバム一覧を選択リストで表示
    function getAlbums(){
        albumsRequest().then((resp) => {
            resp.albums.forEach((album) => {
                console.log(album);
                var title = document.createElement('option');
                title.setAttribute('value', album.id);
                title.innerHTML = album.title;
                console.log(title.innerHTML);
                console.log(title);
                document.getElementById('selectAlbum').appendChild(title);
        	});
        });
    }
    
    // 取得したアルバムの写真をスライドショーで表示させる準備
    function getPhotos(){
        let photosUrl = [];
        photosRequest().then((resp) => {
            resp.mediaItems.forEach((photo) => {
                photosUrl.push(photo.baseUrl);
                console.log(photosUrl);
            });
            let num = -1;
            num = Math.floor(Math.random()*photosUrl.length);
            document.getElementById("photo").src = photosUrl[num];
        });
    }
    
    // 取得したアルバムの写真をスライドショーで表示
    function showPhotos() {
        setInterval(getPhotos,1000); 
    }
    
     // アルバムリスト取得 REST API実行
    function albumsRequest() {
      // Promissで結果を返せるようにする
      return new Promise((resolve, reject) => {
      
        // リクエストの作成
        var restRequest = gapi.client.request({
          'path': 'https://photoslibrary.googleapis.com/v1/albums',
          'params' : {
             'pageSize' : 10    // １回あたり最大１0件のアルバムを取得する
           }
        });

        // リクエストを実行
        restRequest.execute((resp) => {
          if (resp.error) {
            reject(resp.error)  // エラーなのでreject
            //console.log("error");
          } else {
            resolve(resp)       // 正常なのでresolve
            //console.log("ok");
          }
        });
      });  
    }
     
    // アルバムの写真取得 REST API実行
    function photosRequest() {
        // albumIdを受け取る
        const albumId = submitAlbumId();
        
      // Promissで結果を返せるようにする
      return new Promise((resolve, reject) => {
      
        // リクエストの作成
        var restRequest = gapi.client.request({
          'path': 'https://photoslibrary.googleapis.com/v1/mediaItems:search',
          'method': 'POST',
          'body' : {
              "albumId" : albumId,
              "pageSize" : 100
           }
        });

        // リクエストを実行
        restRequest.execute((resp) => {
          if (resp.error) {
            reject(resp.error)  // エラーなのでreject
            console.log("error");
          } else {
            resolve(resp)       // 正常なのでresolve
            console.log("ok");
          }
        });
      });  
    }
    
    // albumIdを取得
    function submitAlbumId() {
        const albumId = document.getElementById("selectAlbum").value;
        console.log(albumId);
        return albumId;
    }        
      </script>
</body>
</html>